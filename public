let items = JSON.parse(localStorage.getItem("items") || "[]");
render();

function addItem() {
  const name = document.getElementById("name").value.trim();
  const qty = document.getElementById("qty").value;
  const expiry = document.getElementById("expiry").value;

  if (!name || !expiry) return alert("Enter name + expiry");

  items.push({ name, qty, expiry, notified: false });
  localStorage.setItem("items", JSON.stringify(items));
  render();
}

function daysLeft(dateStr) {
  const now = new Date();
  const d = new Date(dateStr);
  return Math.ceil((d - now) / (1000 * 60 * 60 * 24));
}

function notify(item) {
  if (Notification.permission === "default") Notification.requestPermission();
  if (Notification.permission === "granted") {
    new Notification("Expiry Alert!", {
      body: `${item.name} expires in ${daysLeft(item.expiry)} days!`
    });
  }
}

setInterval(() => checkExpiries(), 10_000);

function checkExpiries() {
  items.forEach(i => {
    const left = daysLeft(i.expiry);
    if (left <= 7 && left >= 0 && !i.notified) {
      notify(i);
      i.notified = true;
      localStorage.setItem("items", JSON.stringify(items));
    }
  });
}

function render() {
  const container = document.getElementById("list");
  container.innerHTML = "";

  items.forEach((i, idx) => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <strong>${i.name}</strong> (x${i.qty})  
      - Expires: ${i.expiry}  
      - ${daysLeft(i.expiry)} days left  
      <button onclick="showRecipes('${i.name}')">Recipes</button>
    `;
    container.append(div);
  });
}

async function showRecipes(name) {
  const res = await fetch(`/recipes?q=${name}`);
  const data = await res.json();

  const box = document.getElementById("recipes");
  box.innerHTML = "";

  data.forEach(r => {
    const div = document.createElement("div");
    div.className = "recipe";
    div.innerHTML = `<b>${r.title}</b><br>${r.desc}`;
    box.append(div);
  });
}

async function findFoodBanks() {
  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    const res = await fetch(`/foodbanks?lat=${lat}&lon=${lon}`);
    const data = await res.json();

    const box = document.getElementById("foodbanks");
    box.innerHTML = "";

    data.forEach(fb => {
      const div = document.createElement("div");
      div.className = "foodbank";
      div.innerHTML = `
        ${fb.display_name}
        <br>
        <a href="https://www.google.com/maps?q=${fb.lat},${fb.lon}" target="_blank">Open in Maps</a>
      `;
      box.append(div);
    });
  });
}
